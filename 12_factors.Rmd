---
output: html_document
editor_options: 
  chunk_output_type: console
---

## Работа с факторами с помощью пакета `forcats`

### Введение

Факторы используются для работы с категориальными переменными. Их так же можно использовать если нужно отобразить символьные векторы в порядке следования, отличающимся от алфавитного.

#### Используемые ресурсы

```{r}
library(tidyverse)
library(forcats)
```

### Создание факторов

Предположим есть переменная, в которой внесены названия месяцев

```{r}
x1 <- c("Dec", "Apr", "Jan", "Mar")
```

Есть пару проблем с записью строки в эти перменные

* Возможны опечатки

```{r}
x2 <- c("Dec", "Apr", "Jam", "Mar")
```

* Список сортируется не правильно, т.е. он сортируется не по месяцам а по алфавиту.

```{r}
sort(x1)
```

Обе проблемы решаются использованием фактора. Чтобы создать фактор нужно

1. Создать список допустимых уровней.

```{r}
month_levels <- c(
  "Jan", "Feb", "Mar", "Apr", "May", "Jun", 
  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
)
```

1. Теперь можно создать фактор

```{r}
y1 <- factor(x1, levels = month_levels)
y1
sort(y1)
```

Любые значения не входящие в этот набор автоматически будут преобразовываться в `NA`. 

```{r}
y2 <- factor(x2, levels = month_levels)
y2
```

Можно получить сообщения об ошибках, используя функцию `readr::parse_factor()`

```{r}
y2 <- parse_factor(x2, levels = month_levels)
```

Если опустить уровни, они будут браться из данных в алфавитном порядке

```{r}
factor(x1)
```

Иногда предпочтительнее, чтобы порядок уровней совпадал с порядком первого появления в данных. Можно сделать это в процессе создания фактора путем задания уровней для функции `unique()` или уже постфактум с помощью функции `fct_inorder()`

```{r}
f1 <- factor(x1, levels = unique(x1))
f1
f2 <- x1 %>% factor() %>% fct_inorder()
f2
```

Если потребуется непосредственный доступ к набору допустимых уровней, это можно сделать с помошью функции `levels()`

```{r}
levels(f2)
```

### Опрос GSS

В оставшейся части главы работаем с `forcats::gss_cat` это данные, предоставленные General Society Survey --- общенациональный социальный опрос США

```{r}
gss_cat
```

Информация о перменных по запросу хэлпа `?gss_cat`.

Если факторы хранятся в тиббле-фрэйме, мы не сможем увидеть их, не предпринимая никаких мер. Один из способов использовать функцию `count()`. Другой --- более наглядный, использовать построение диаграмой.

```{r}
gss_cat %>% count(race)

ggplot(gss_cat, aes(race)) +
  geom_bar()
```

По умолчанию опускаются уровни, в которых не было ни одного значения, это не всегда полезно. Иногда нужно посмотреть и не встречающиеся значения. Для этого нужно принудлительно просить R показать таких перменные при помощи функции `scale_x_discrete()`

```{r}
ggplot(gss_cat, aes(race)) +
  geom_bar() +
  scale_x_discrete(drop = FALSE)
```

#### Упражнение 14.2.5.4
<div class="question">
Explore the distribution of `rincome` (reported income). What makes the default bar chart hard to understand? How could you improve the plot?
</div>

Всё потому что подписи по абсциссе смешались в кучу. 

```{r}
gss_cat %>%
  count(rincome)

rincome_plot <- ggplot(gss_cat, aes(rincome)) +
  geom_bar()
```

Первым шагом можно повернуть оси

```{r}
rincome_plot +
  coord_flip()
```

Или, как один из вариантов решения --- перевернуть подписи на 90 градусов

```{r}
rincome_plot + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Или на другой угол, при котором будут хорошо читаться подписи.

```{r}
rincome_plot + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Но мне всё же больше нравится вариант с поворотом оси.

Далее видно, что из информативного представления о количестве зарплаты, выбиваются те кто либо не знают, не могут ответить, или не захотелили отвечать. Эта информация может быть статистически полезна, но прям хочется убрать тех кто указал "неприемлемую" зарплату

```{r}
gss_cat %>%
  filter(!rincome %in% c("Not applicable")) %>%
  ggplot(aes(rincome)) +
  geom_bar() +
  coord_flip() +
  scale_y_continuous("Number of Respondents", labels = function(x) paste0(x/1000, "k")) +
  scale_x_discrete("Respondent's Income")
```

