---
output: html_document
editor_options: 
  chunk_output_type: console
---

## Обработка множества моделей с помощью пакетов `purrr` и `broom`
### Введение

Тут советуют не отчаиваться если сразу не получится осмыслить всё то что здесь объясняется.

#### Необходимые ресурсы

```{r}
library(tidyverse)
library(modelr)
```

### Набор данных `gapminder`

В наборе соз=держится информация об изменении во времени суммарных показателей развития стран мира, рассчитанных на основк таких статистик как средняя продолжительность жизни и ВВП.

```{r}
library(gapminder)
gapminder
```

В данном примере мы сосредоточим внимание всего лишь на трех переменных и попытаемся ответить на вопрос: "Как изменяется средняя продолжительность жизни `lifeExp` со временем `year` для каждой страны `country`.

```{r}
gapminder %>% 
  ggplot(aes(year, lifeExp, group = country)) +
  geom_line()
```

Набор хоть и небольшой но тем не менее так сразу и не скажешь что тут происходит.
Один из способов заключается в том, чтобы использовать тот же подход, что и в предыдущей главе: существует один сильный сигнал (общий линейный тренд), который затрудняет наблюдение более слабых трендов.
Мы разведем эти факторы посредством построения модели с линейным трендом.
Эта модель захватит постоянный рост во времени, а остатки покажут, что остается.

Мы знаем как сделать это для одной страны.

```{r}
nz <- filter(gapminder, country == "New Zealand")

nz %>% 
  ggplot(aes(year, lifeExp)) +
  geom_line() +
  ggtitle("Full data")

nz_mod <- lm(lifeExp ~ year, data = nz)

nz %>% 
  add_predictions(nz_mod) %>% 
  ggplot(aes(year, pred)) +
  geom_line() +
  ggtitle("Linear trend")

nz %>% 
  add_residuals(nz_mod) %>% 
  ggplot(aes(year, resid)) +
  geom_line() +
  ggtitle("Remaining pattern")
```

Теперь посмотрим как строить модель для каждой страны.

#### Вложенные данные